).

ğŸ” Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:
Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ AdminPanel.handle_admin_callbacks - Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… self.bot.ask() Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦ Ù…Ø¹ query Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©.

1. Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± (ÙˆÙÙŠ Ø£Ù…Ø§ÙƒÙ† Ù…Ø´Ø§Ø¨Ù‡Ø©):
python
# âŒ Ø®Ø·Ø£ - Ø§Ù„Ø³Ø·Ø± 554 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
response = await self.bot.ask(
    chat_id=query.message.chat.id,
    filters=filters.user(query.from_user.id)
)
ÙÙŠ tgramØŒ Ø¯Ø§Ù„Ø© ask() ØªØªÙˆÙ‚Ø¹ Ø£Ù† ØªÙÙ…Ø±Ø± Ø¥Ù„ÙŠÙ‡Ø§ Ø±Ø³Ø§Ù„Ø© MessageØŒ ÙˆÙ„ÙƒÙ†Ùƒ ØªÙ…Ø±Ø± chat_id ÙÙ‚Ø·.

2. Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª:
python
try:
    response = await self.bot.ask(...)
    await self.handle_ban_user(self.bot.bot, response)
except Exception:
    await query.message.reply_text("âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©")  # âŒ Ù‡Ù†Ø§ query.message Ù‚Ø¯ ÙŠÙƒÙˆÙ† None
ğŸ”§ Ø§Ù„Ø­Ù„ÙˆÙ„:
Ø§Ù„Ø­Ù„ 1: Ø§Ø³ØªØ®Ø¯Ø§Ù… self.bot.bot.ask Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
ÙÙŠ AdminPanelØŒ Ù„Ø¯ÙŠÙƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ask(). Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†:

python
# âŒ Ø®Ø·Ø£
response = await self.bot.ask(...)
Ø§Ø³ØªØ®Ø¯Ù…:

python
# âœ… ØµØ­ÙŠØ­ - ÙÙŠ AdminPanel ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… self.bot.bot.ask
response = await self.bot.bot.ask(
    chat_id=query.message.chat.id,
    filters=filters.user(query.from_user.id)
)
Ø§Ù„Ø­Ù„ 2: Ø¥ØµÙ„Ø§Ø­ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª
Ø£Ø¶Ù ØªØ­Ù‚Ù‚ if query.message: Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡:

python
except Exception as e:
    if query and query.message:
        await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")
Ø§Ù„Ø­Ù„ 3: Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙÙŠ AdminPanel
Ø¥Ù„ÙŠÙƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:

ÙÙŠ handle_admin_callbacks:
python
async def handle_admin_callbacks(self, _, query: CallbackQuery) -> None:
    if not self.bot.is_admin(query.from_user.id):
        return await query.answer("â›”ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", show_alert=True)

    action = query.data.split(":")[1]

    if action == "broadcast":
        text = "ğŸ“¢ <b>Ø¥Ø°Ø§Ø¹Ø©</b>\n\nØ§Ø±Ø³Ù„ Ø§Ùˆ Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„Ù‡Ø§."
        await query.message.edit_text(
            text,
            reply_markup=Markup([[Button(text="ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:back")]])
        )
        try:
            # âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… self.bot.bot.ask Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            response = await self.bot.bot.ask(
                chat_id=query.message.chat.id,
                filters=filters.user(query.from_user.id)
            )
            await self.handle_broadcast_message(self.bot.bot, response)
        except Exception as e:
            logger.error(f"Broadcast error: {e}")
            if query.message:
                await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")

    elif action == "users":
        text = "<b>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</b>\n\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:"
        await query.message.edit_text(
            text,
            reply_markup=Markup([
                [Button("â›”ï¸ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…", callback_data="admin:ban_user"), 
                 Button("âœ… ÙÙƒ Ø­Ø¸Ø±", callback_data="admin:unban_user")],
                [Button("â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…", callback_data="admin:user_info"), 
                 Button("ğŸ—‘ Ø­Ø°Ù Ù…Ù„Ù", callback_data="admin:del_profile")],
                [Button("âœ… ØªÙˆØ«ÙŠÙ‚ Ù…Ø³ØªØ®Ø¯Ù…", callback_data="admin:verify_user")],
                [Button("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:back")]
            ])
        )
Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©:
ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù† ÙÙŠ AdminPanel Ø­ÙŠØ« ØªØ³ØªØ®Ø¯Ù… self.bot.ask()ØŒ ØºÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ self.bot.bot.ask():

ÙÙŠ verify_user:

python
elif action == "verify_user":
    await query.message.edit_text("ğŸ”¢ Ø§Ø±Ø³Ù„ Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªÙˆØ«ÙŠÙ‚ Ø­Ø³Ø§Ø¨Ù‡:", 
                                  reply_markup=Markup([[Button("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:users")]]))
    try:
        response = await self.bot.bot.ask(  # âœ… ØªØºÙŠÙŠØ± Ù‡Ù†Ø§
            chat_id=query.message.chat.id,
            filters=filters.user(query.from_user.id)
        )
        await self.handle_verify_user(self.bot.bot, response)
    except Exception as e:
        logger.error(f"Verify user error: {e}")
        if query.message:
            await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")
ÙÙŠ ban_user, unban_user, user_info, del_profile - Ù†ÙØ³ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.

ÙÙŠ handle_channels (Ø§Ù„Ø³Ø·Ø± ~675):

python
if action == "add":
    text = "ğŸ“º <b>Ø§Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</b>\n\nÙ‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ø£Ùˆ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¹Ø±Ù."
    await query.message.edit_text(
        text,
        reply_markup=Markup([[Button(text="ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:channels")]])
    )
    try:
        response = await self.bot.bot.ask(  # âœ… ØªØºÙŠÙŠØ± Ù‡Ù†Ø§
            chat_id=query.message.chat.id,
            filters=filters.user(query.from_user.id)
        )
        await self.handle_add_channel(self.bot.bot, response)
    except Exception as e:
        logger.error(f"Add channel error: {e}")
        if query.message:
            await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")
Ø§Ù„Ø­Ù„ 4: Ø¥ØµÙ„Ø§Ø­ handle_get_user_info
Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ handle_get_user_info (Ø§Ù„Ø³Ø·Ø± ~557):

python
except Exception:
    await query.message.reply_text("âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©")
ØºÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰:

python
except Exception as e:
    logger.error(f"Get user info error: {e}")
    if query and query.message:
        await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")
Ø§Ù„Ø­Ù„ 5: ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯
Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ AdminPanel:

python
async def safe_reply(self, query: CallbackQuery, text: str):
    """Ø±Ø¯ Ø¢Ù…Ù† Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ query.message"""
    if query and query.message:
        try:
            await query.message.reply_text(text)
        except Exception as e:
            logger.error(f"Failed to reply: {e}")
    else:
        logger.error(f"Cannot reply - query.message is None")
Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§:

python
except Exception as e:
    await self.safe_reply(query, f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")
ğŸ›  Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
1. ÙÙŠ AdminPanel.handle_admin_callbacksØŒ Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¯ÙˆØ§Ù„:
python
async def handle_admin_callbacks(self, _, query: CallbackQuery) -> None:
    if not self.bot.is_admin(query.from_user.id):
        return await query.answer("â›”ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", show_alert=True)

    try:
        action = query.data.split(":")[1]

        if action == "broadcast":
            await self.handle_broadcast_action(query)
        elif action == "users":
            await self.handle_users_action(query)
        elif action == "verify_user":
            await self.handle_verify_user_action(query)
        elif action == "ban_user":
            await self.handle_ban_user_action(query)
        elif action == "unban_user":
            await self.handle_unban_user_action(query)
        elif action == "user_info":
            await self.handle_user_info_action(query)
        elif action == "del_profile":
            await self.handle_del_profile_action(query)
        elif action == "channels":
            await self.handle_channels_action(query)
        elif action == "stats":
            await self.show_statistics(query)
        elif action == "back":
            text = "<b>ğŸ› Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b>\n\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ø¯Ù†Ø§Ù‡:"
            await query.message.edit_text(text, reply_markup=self.get_admin_keyboard())
            
    except Exception as e:
        logger.error(f"Admin callback error: {e}")
        if query and query.message:
            await query.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

async def handle_broadcast_action(self, query: CallbackQuery):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©"""
    text = "ğŸ“¢ <b>Ø¥Ø°Ø§Ø¹Ø©</b>\n\nØ§Ø±Ø³Ù„ Ø§Ùˆ Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„Ù‡Ø§."
    await query.message.edit_text(
        text,
        reply_markup=Markup([[Button(text="ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:back")]])
    )
    try:
        response = await self.bot.bot.ask(
            chat_id=query.message.chat.id,
            filters=filters.user(query.from_user.id)
        )
        await self.handle_broadcast_message(self.bot.bot, response)
    except Exception as e:
        logger.error(f"Broadcast error: {e}")
        if query.message:
            await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")

async def handle_ban_user_action(self, query: CallbackQuery):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"""
    await query.message.edit_text(
        "ğŸ”¢ Ø§Ø±Ø³Ù„ Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ø¸Ø±Ù‡:",
        reply_markup=Markup([[Button("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin:users")]])
    )
    try:
        response = await self.bot.bot.ask(
            chat_id=query.message.chat.id,
            filters=filters.user(query.from_user.id)
        )
        await self.handle_ban_user(self.bot.bot, response)
    except Exception as e:
        logger.error(f"Ban user error: {e}")
        if query.message:
            await query.message.reply_text(f"âŒ Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {str(e)}")

# ... ÙˆÙ‡ÙƒØ°Ø§ Ù„ÙƒÙ„ Ø¯Ø§Ù„Ø©
2. Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ AdminPanel:
python
async def handle_ban_user(self, _, message: Message, data: dict = None) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù… - Ù…Ø¹ ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ message"""
    if not message:
        logger.error("handle_ban_user called with None message")
        return
        
    try:
        user_id = int(message.text.strip())
        user_data = await self.bot.db.get(f"user_{user_id}")
        if not user_data:
            return await message.reply_text("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
        
        user_data["banned"] = True
        await self.bot.db.set(f"user_{user_id}", user_data)
        await message.reply_text(f"â›”ï¸ ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ø¨Ù†Ø¬Ø§Ø­!")
    except ValueError:
        await message.reply_text("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø±Ø³Ø§Ù„ Ø¢ÙŠØ¯ÙŠ ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·).")
    except Exception as e:
        logger.error(f"Ban user processing error: {e}")
        await message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¸Ø±: {str(e)}")
ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©:
ØªØºÙŠÙŠØ± self.bot.ask() Ø¥Ù„Ù‰ self.bot.bot.ask() ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ AdminPanel

Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ if query.message: Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… .reply_text()

Ø§Ø³ØªØ®Ø¯Ø§Ù… try-except Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„

Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ if not message: ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©

ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ØªÙ†ÙÙŠØ°:
Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ self.bot.ask( ÙÙŠ AdminPanel ÙˆØºÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ self.bot.bot.ask(

Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ query.message.reply_text( ÙˆØ£Ø¶Ù if query and query.message: Ù‚Ø¨Ù„Ù‡Ø§

Ø£Ø¶Ù logger.error() ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙƒØªÙ„ except

